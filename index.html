<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Before–Action–After Uploader PDF By Pohara Ayub</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #f4f4f9;
  margin: 0;
  padding: 16px;
}
h1 { text-align: center; font-size: 20px; margin-bottom: 15px; }

.controls { 
  display: flex; 
  flex-direction: column;
  align-items: center; 
  gap: 12px; 
  margin-bottom: 20px; 
}

button { 
  background: #007bff; 
  color: white; 
  border: none; 
  padding: 10px 16px; 
  border-radius: 8px; 
  cursor: pointer; 
  transition: background 0.3s;
}
button:hover {
  background: #0056b3;
}
button:disabled {
  background: #6c757d;
  cursor: not-allowed;
}
button.ghost { 
  background: #6c757d; 
}
button.ghost:hover {
  background: #545b62;
}

.note { 
  font-size: 12px; 
  color: #666; 
  text-align: center; 
  max-width: 500px;
}

.status {
  font-size: 12px;
  color: #28a745;
  font-weight: bold;
  margin-top: 5px;
}

.pairs { display: flex; flex-direction: column; gap: 15px; }

.pair { 
  background: white; 
  border-radius: 10px; 
  box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
  padding: 10px; 
  position: relative;
}

.job-name {
  margin-bottom: 8px;
  text-align: center;
}
.job-name input {
  width: 90%;
  padding: 6px 8px;
  font-size: 14px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

.images { 
  display: flex; 
  justify-content: center; 
  align-items: flex-start; 
  gap: 10px; 
}

.image-block { 
  flex: 1; 
  text-align: center; 
  min-height: 150px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  border: 1px dashed #ddd;
  border-radius: 8px;
  padding: 5px;
}
.image-block img { 
  width: 100%; 
  max-width: 500px; 
  border-radius: 8px; 
  object-fit: contain; 
  max-height: 300px;
}

.label {
  font-size: 14px;
  font-weight: bold;
  margin-bottom: 6px;
  color: #333;
}

.action-upload {
  text-align: center;
  margin-top: 8px;
}

.remove-pair {
  position: absolute;
  top: 5px;
  right: 10px;
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 50%;
  width: 25px;
  height: 25px;
  cursor: pointer;
  font-size: 12px;
}

@media (max-width: 600px) {
  .images { flex-wrap: wrap; }
}

footer { text-align: center; font-size: 12px; color: #777; margin-top: 20px; }

.loading {
  display: none;
  text-align: center;
  margin: 10px 0;
  color: #007bff;
}

.progress-bar {
  width: 100%;
  height: 20px;
  background: #f0f0f0;
  border-radius: 10px;
  margin: 10px 0;
  overflow: hidden;
}

.progress {
  height: 100%;
  background: #007bff;
  width: 0%;
  transition: width 0.3s;
}

.pdf-preview {
  display: none;
  margin: 20px auto;
  border: 1px solid #ccc;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  max-width: 100%;
}
</style>
</head>
<body>

<h1>Before – Action – After Uploader PDF By Pohara Ayub</h1>

<div class="controls">
  <input type="file" id="fileInput" accept="image/*" multiple>
  <div class="status" id="statusInfo">Belum ada foto diunggah</div>
  <div>
    <button id="clearAll" class="ghost">Hapus Semua</button>
    <button id="generatePdf">Generate PDF HD</button>
  </div>
  <div class="note">Upload 2 foto per set: Before – After. Foto Action opsional di setiap set. Maksimal 600 foto (300 set). Nama Pekerjaan opsional.</div>
</div>

<div class="loading" id="loadingIndicator">
  <div>Membuat PDF HD...</div>
  <div class="progress-bar">
    <div class="progress" id="progressBar"></div>
  </div>
  <div id="progressText">0%</div>
</div>

<div id="pairs" class="pairs"></div>

<footer>
  <div>Library: html2canvas + jsPDF</div>
  <div>Generated on client — tidak ada upload ke server.</div>
</footer>

<script>
const pairsContainer = document.getElementById('pairs');
const statusInfo = document.getElementById('statusInfo');
const loadingIndicator = document.getElementById('loadingIndicator');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
let totalPhotos = 0;
const MAX_PHOTOS = 600;

// Update status
function updateStatus() {
  const pairCount = document.querySelectorAll('.pair').length;
  statusInfo.textContent = `${pairCount} set pekerjaan (${totalPhotos} foto) diunggah`;
  
  // Enable/disable tombol Generate PDF
  document.getElementById('generatePdf').disabled = pairCount === 0;
}

// Hapus semua
document.getElementById('clearAll').addEventListener('click', () => {
  pairsContainer.innerHTML = '';
  totalPhotos = 0;
  updateStatus();
});

// Upload file
document.getElementById('fileInput').addEventListener('change', e => {
  const files = Array.from(e.target.files);

  if (files.length === 0) return;

  if (files.length + totalPhotos > MAX_PHOTOS) {
    alert(`Maksimal 600 foto tercapai! Anda sudah mengunggah ${totalPhotos} foto.`);
    return;
  }

  if (files.length % 2 !== 0) {
    alert("Harus upload 2 foto per set: Before – After.");
    return;
  }

  for (let i = 0; i < files.length; i += 2) {
    const pair = document.createElement('div');
    pair.className = 'pair';
    pair.innerHTML = `
      <button class="remove-pair" title="Hapus set ini">×</button>
      <div class="job-name">
        <input type="text" placeholder="Nama Pekerjaan (opsional)">
      </div>
      <div class="images">
        <div class="image-block before">
          <div class="label">BEFORE</div>
        </div>
        <div class="image-block after">
          <div class="label">AFTER</div>
        </div>
      </div>
      <div class="action-upload">
        <input type="file" class="actionInput" accept="image/*">
      </div>
    `;
    pairsContainer.appendChild(pair);

    // Event untuk menghapus pair
    pair.querySelector('.remove-pair').addEventListener('click', () => {
      const beforeImg = pair.querySelector('.before img');
      const actionImg = pair.querySelector('.action img');
      const afterImg = pair.querySelector('.after img');
      
      totalPhotos -= (beforeImg ? 1 : 0) + (actionImg ? 1 : 0) + (afterImg ? 1 : 0);
      pair.remove();
      updateStatus();
    });

    // Load Before
    const reader1 = new FileReader();
    reader1.onload = ev => {
      const img = document.createElement('img');
      img.src = ev.target.result;
      img.onload = function() {
        pair.querySelector('.before').appendChild(img);
      };
    };
    reader1.readAsDataURL(files[i]);

    // Load After
    const reader2 = new FileReader();
    reader2.onload = ev => {
      const img = document.createElement('img');
      img.src = ev.target.result;
      img.onload = function() {
        pair.querySelector('.after').appendChild(img);
      };
    };
    reader2.readAsDataURL(files[i + 1]);

    // Event untuk input Action opsional
    const actionInput = pair.querySelector('.actionInput');
    actionInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        let imagesDiv = pair.querySelector('.images');
        let actionBlock = imagesDiv.querySelector('.action');
        if (!actionBlock) {
          // buat block Action di tengah
          actionBlock = document.createElement('div');
          actionBlock.className = 'image-block action';
          const label = document.createElement('div');
          label.className = 'label';
          label.innerText = 'ACTION';
          actionBlock.appendChild(label);
          imagesDiv.insertBefore(actionBlock, pair.querySelector('.after'));
          totalPhotos += 1;
          updateStatus();
        } else {
          actionBlock.innerHTML = '<div class="label">ACTION</div>';
        }
        const img = document.createElement('img');
        img.src = ev.target.result;
        img.onload = function() {
          actionBlock.appendChild(img);
        };
      };
      reader.readAsDataURL(file);
    });

    totalPhotos += 2;
  }

  updateStatus();
  e.target.value = '';
});

// Generate PDF HD
document.getElementById('generatePdf').addEventListener('click', async () => {
  const pairs = document.querySelectorAll('.pair');
  if (pairs.length === 0) {
    alert('Belum ada foto!');
    return;
  }

  // Tampilkan loading indicator
  loadingIndicator.style.display = 'block';
  progressBar.style.width = '0%';
  progressText.textContent = '0%';

  try {
    const { jsPDF } = window.jspdf;
    // Format A4 landscape dengan kualitas tinggi
    const pdf = new jsPDF({ 
      orientation: 'landscape', 
      unit: 'mm', 
      format: 'a4',
      compress: true
    });

    for (let i = 0; i < pairs.length; i++) {
      const pair = pairs[i];
      const jobInput = pair.querySelector('.job-name input');
      const jobText = jobInput.value.trim();

      // Update progress
      const progress = ((i + 1) / pairs.length) * 100;
      progressBar.style.width = `${progress}%`;
      progressText.textContent = `${Math.round(progress)}%`;

      // Buat elemen sementara untuk rendering
      const tempDiv = document.createElement('div');
      tempDiv.style.width = '297mm'; // A4 width in landscape
      tempDiv.style.padding = '20px';
      tempDiv.style.background = 'white';
      tempDiv.style.boxSizing = 'border-box';

      // Tambahkan judul pekerjaan jika ada
      if (jobText) {
        const jobTitle = document.createElement('div');
        jobTitle.style.fontSize = '18px';
        jobTitle.style.fontWeight = 'bold';
        jobTitle.style.textAlign = 'center';
        jobTitle.style.marginBottom = '15px';
        jobTitle.style.color = '#333';
        jobTitle.innerText = jobText;
        tempDiv.appendChild(jobTitle);
      }

      // Clone images container
      const imagesClone = pair.querySelector('.images').cloneNode(true);
      
      // Style untuk clone
      imagesClone.style.display = 'flex';
      imagesClone.style.justifyContent = 'space-between';
      imagesClone.style.gap = '10px';
      imagesClone.style.width = '100%';
      
      // Style untuk image blocks
      const imageBlocks = imagesClone.querySelectorAll('.image-block');
      imageBlocks.forEach(block => {
        block.style.flex = '1';
        block.style.minHeight = '150px';
        block.style.display = 'flex';
        block.style.flexDirection = 'column';
        block.style.alignItems = 'center';
        block.style.border = '1px solid #ddd';
        block.style.borderRadius = '8px';
        block.style.padding = '10px';
        block.style.background = '#f9f9f9';
      });
      
      // Style untuk labels
      const labels = imagesClone.querySelectorAll('.label');
      labels.forEach(label => {
        label.style.fontSize = '16px';
        label.style.fontWeight = 'bold';
        label.style.marginBottom = '10px';
        label.style.color = '#333';
      });
      
      // Style untuk images
      const images = imagesClone.querySelectorAll('img');
      images.forEach(img => {
        img.style.maxWidth = '100%';
        img.style.maxHeight = '160mm';
        img.style.objectFit = 'contain';
        img.style.borderRadius = '4px';
      });

      tempDiv.appendChild(imagesClone);
      document.body.appendChild(tempDiv);

      try {
        // Render dengan kualitas tinggi
        const canvas = await html2canvas(tempDiv, {
          scale: 2, // Kualitas 2x
          useCORS: true,
          logging: false,
          width: tempDiv.offsetWidth,
          height: tempDiv.offsetHeight,
          windowWidth: tempDiv.scrollWidth,
          windowHeight: tempDiv.scrollHeight
        });

        const imgData = canvas.toDataURL('image/jpeg', 0.9); // Kualitas 90%

        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        
        // Hitung dimensi gambar agar pas di halaman
        const imgWidth = canvas.width;
        const imgHeight = canvas.height;
        const ratio = Math.min(pageWidth / imgWidth, pageHeight / imgHeight);
        const imgWidthFinal = imgWidth * ratio;
        const imgHeightFinal = imgHeight * ratio;

        const x = (pageWidth - imgWidthFinal) / 2;
        const y = (pageHeight - imgHeightFinal) / 2;

        if (i > 0) pdf.addPage();
        pdf.addImage(imgData, 'JPEG', x, y, imgWidthFinal, imgHeightFinal);

      } catch (err) {
        console.error('Error generating canvas:', err);
        alert('Terjadi kesalahan saat membuat PDF. Coba kurangi jumlah foto.');
      } finally {
        document.body.removeChild(tempDiv);
      }

      // Beri waktu untuk UI update
      await new Promise(resolve => setTimeout(resolve, 100));
    }

    // Simpan PDF
    pdf.save(`before-action-after-${new Date().getTime()}.pdf`);
    
  } catch (error) {
    console.error('Error generating PDF:', error);
    alert('Terjadi kesalahan saat membuat PDF.');
  } finally {
    // Sembunyikan loading indicator
    loadingIndicator.style.display = 'none';
  }
});

// Inisialisasi status
updateStatus();
</script>
</body>
</html>